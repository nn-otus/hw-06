## ДЗ-06 Работа с NFS
#### Описание домашнего задания 
##### Основная часть: 
+ запустить 2 виртуальных машины (сервер NFS и клиента);
+ на сервере NFS должна быть подготовлена и экспортирована директория; 
в экспортированной директории должна быть поддиректория с именем upload с правами на запись в неё; 
+ экспортированная директория должна автоматически монтироваться на клиенте при старте виртуальной машины (systemd, autofs или fstab — любым способом);
+ монтирование и работа NFS на клиенте должна быть организована с использованием NFSv3.
##### Для самостоятельной реализации: 
+ настроить аутентификацию через KERBEROS с использованием NFSv4.


### Настраиваем сервер NFS
```
root@u24srv06:~# hostname ; ip a | grep 192
u24srv06     inet 192.168.0.14/24 
```
##### Установим сервер NFS
```
root@u24srv06:~# apt install nfs-kernel-server
Reading package lists... Done
...
```
Проверяем наличие слушающих портов 2049/udp, 2049/tcp,111/udp, 111/tcp
```
root@u24srv06:~# ss -4lnptu | grep -e 2049 -e 111
udp   UNCONN 0      0                 0.0.0.0:111        0.0.0.0:*    users:(("rpcbind",pid=1467,fd=5),("systemd",pid=1,fd=180))
tcp   LISTEN 0      64                0.0.0.0:2049       0.0.0.0:*
tcp   LISTEN 0      4096              0.0.0.0:111        0.0.0.0:*    users:(("rpcbind",pid=1467,fd=4),("systemd",pid=1,fd=179))
```
Создаём и настраиваем директорию, которая будет экспортирована в будущем
```
root@u24srv06:~# mkdir -p /srv/share/upload
root@u24srv06:~# chown -R nobody:nogroup /srv/share
root@u24srv06:~# chmod 0777 /srv/share/upload
```
Cоздаём в файле /etc/exports структуру, которая позволит экспортировать ранее созданную директорию
```
root@u24srv06:~# echo "/srv/share 192.168.0.0/24(rw,sync,root_squash)" >> /etc/exports
cat /etc/exports
/srv/share 192.168.0.0/24(rw,sync,root_squash)
root@u24srv06:~#
```
Экспортируем ранее созданную директорию
```
root@u24srv06:~# exportfs -r
exportfs: /etc/exports [1]: Neither 'subtree_check' or 'no_subtree_check' specified for export "192.168.0.0/24:/srv/share".
  Assuming default behaviour ('no_subtree_check').
  NOTE: this default has changed since nfs-utils version 1.0.x

```
Проверяем экспортированную директорию командой exportfs -s
```
root@u24srv06:~# exportfs -s
/srv/share  192.168.0.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,root_squash,no_all_squash)
root@u24srv06:~#

```
### Настраиваем клиент NFS
```
root@u24cln06:~# hostname
u24cln06
root@u24cln06:~# ip a | grep 192
    inet 192.168.0.15/24 metric 100 brd 192.168.0.255 scope global dynamic ens33
root@u24cln06:~#
```
##### Установим пакет nfs-common
```
root@u24cln06:~# apt install nfs-common
Reading package lists... Done
```
##### Монтируем экспортированный каталог 
```
root@u24cln06:~# mount -t nfs 192.168.0.14:/srv/share /media/share_on_srv06/
root@u24cln06:~# ls -l /media/share_on_srv06/
total 4
drwxrwxrwx 2 nobody nogroup 4096 Jul 19 12:09 upload
root@u24cln06:~# touch /media/share_on_srv06/upload/testfile-from-cln06
root@u24cln06:~# ls -l /media/share_on_srv06/upload/
total 0
-rw-r--r-- 1 nobody nogroup 0 Jul 19 14:22 testfile-from-cln06
root@u24cln06:~#
```
*Примонтированный по NFS каталог доступен на запись

##### Добавляем общий ресурс сервера в /etc/fstab
```
root@u24cln06:~# echo "192.168.0.14:/srv/share/ /media/share_on_srv06 nfs vers=3,noauto,x-systemd.automount 0 0" >> /etc/fstab
root@u24cln06:~#
```

##### Перечитываем /etc/fstab и рестартуем remote-fs
```
root@u24cln06:~# systemctl daemon-reload
root@u24cln06:~# systemctl restart remote-fs.target
root@u24cln06:~#
```
##### Проверяем созданные unit-файлы
```
root@u24cln06:~# cat /run/systemd/generator/media-share_on_srv06.automount
# Automatically generated by systemd-fstab-generator

[Unit]
SourcePath=/etc/fstab
Documentation=man:fstab(5) man:systemd-fstab-generator(8)

[Automount]
Where=/media/share_on_srv06
root@u24cln06:~#
root@u24cln06:~# cat /run/systemd/generator/media-share_on_srv06.mount
# Automatically generated by systemd-fstab-generator

[Unit]
Documentation=man:fstab(5) man:systemd-fstab-generator(8)
SourcePath=/etc/fstab
Before=remote-fs.target

[Mount]
What=192.168.0.14:/srv/share/
Where=/media/share_on_srv06
Type=nfs
Options=vers=3,noauto,x-systemd.automount
root@u24cln06:~#
```
##### Проверяем вывод команды mount
```
root@u24cln06:~# mount | grep media
systemd-1 on /media/share_on_srv06 type autofs (rw,relatime,fd=65,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=11154)
192.168.0.14:/srv/share/ on /media/share_on_srv06 type nfs (rw,relatime,vers=3,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.0.14,mountvers=3,mountport=42768,mountproto=udp,local_lock=none,addr=192.168.0.14)
root@u24cln06:~#
```
* Примечание: потребовалась перезагрузка, чтобы mount выдала 3-ю версию nfs. Без перезагрузки в выводе была версия 4 
##### Проверяем работоспособность NFS

###### Создаем файл на сервере
```
root@u24srv06:~#
root@u24srv06:~# touch /srv/share/upload/testfile-from-srv06
root@u24srv06:~#
```
###### Проверяем его доступность на клиенте
```
root@u24cln06:~# ls -l /media/share_on_srv06/upload/
total 0
-rw-r--r-- 1 nobody nogroup 0 Jul 19 14:22 testfile-from-cln06
-rw-r--r-- 1 root   root    0 Jul 19 15:24 testfile-from-srv06
root@u24cln06:~#
```
###### Перезагружаем сервер и клиент
```
root@u24srv06:~# shutdown -r now
root@u24cln06:~# shutdown -r now
```
###### Проверяем каталог upload на сервере и на клиенте
```
root@u24srv06:~# ls -l /srv/share/upload/
total 0
-rw-r--r-- 1 nobody nogroup 0 Jul 19 14:22 testfile-from-cln06
-rw-r--r-- 1 root   root    0 Jul 19 15:24 testfile-from-srv06
root@u24srv06:~#

nn@u24cln06:~$ ls -l /media/share_on_srv06/upload/
total 0
-rw-r--r-- 1 nobody nogroup 0 Jul 19 14:22 testfile-from-cln06
-rw-r--r-- 1 root   root    0 Jul 19 15:24 testfile-from-srv06
nn@u24cln06:~$
```
###### На сервере проверяем exportfs -s и showmount -addr
```
root@u24srv06:~# exportfs -s
/srv/share  192.168.0.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,root_squash,no_all_squash)
root@u24srv06:~#
root@u24srv06:~# showmount -a
All mount points on u24srv06:
192.168.0.15:/srv/share
root@u24srv06:~#
```
###### На клиенте проверяем RPC, статус монтирования, а также создаем финальный тестовый файл
```
nn@u24cln06:~$ echo "=== Проверяем работу RPC ==="
=== Проверяем работу RPC ===
nn@u24cln06:~$ showmount -a 192.168.0.14
All mount points on 192.168.0.14:
192.168.0.15:/srv/share
nn@u24cln06:~$
nn@u24cln06:~$ echo "=== Проверяем монтирование  ==="
=== Проверяем монтирование  ===
nn@u24cln06:~$ mount | grep media
systemd-1 on /media/share_on_srv06 type autofs (rw,relatime,fd=56,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=4895)
192.168.0.14:/srv/share/ on /media/share_on_srv06 type nfs (rw,relatime,vers=3,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.0.14,mountvers=3,mountport=51622,mountproto=udp,local_lock=none,addr=192.168.0.14)
nn@u24cln06:~$
nn@u24cln06:~$ echo "=== Создаем файл в примонтированном каталоге  ==="
=== Создаем файл в примонтированном каталоге  ===
nn@u24cln06:~$ touch /media/share_on_srv06/upload/finaltest-from-cln06
nn@u24cln06:~$ ls  -l !$
ls  -l /media/share_on_srv06/upload/finaltest-from-cln06
-rw-rw-r-- 1 nn nn 0 Jul 19 17:23 /media/share_on_srv06/upload/finaltest-from-cln06
nn@u24cln06:~$ ls  -l /media/share_on_srv06/upload/
total 0
-rw-rw-r-- 1 nn     nn      0 Jul 19 17:23 finaltest-from-cln06
-rw-r--r-- 1 nobody nogroup 0 Jul 19 14:22 testfile-from-cln06
-rw-r--r-- 1 root   root    0 Jul 19 15:24 testfile-from-srv06
nn@u24cln06:~$
=== Проверяем файл на сервере ===
root@u24srv06:~# ls -l /srv/share/upload/
total 0
-rw-rw-r-- 1 nn     nn      0 Jul 19 17:23 finaltest-from-cln06
-rw-r--r-- 1 nobody nogroup 0 Jul 19 14:22 testfile-from-cln06
-rw-r--r-- 1 root   root    0 Jul 19 15:24 testfile-from-srv06
root@u24srv06:~#
```
### Скрипт установки сервера NFS
 ```
#!/bin/bash
# Скрипт выполняет настройку сервера NFS на Ubuntu 
# Блок переменных - подставить нужные значения
server_ip="192.168.0.14"
access_ip="192.168.0.0/24"
export_dir="/srv/share/upload"
data_dir="/srv/share"
opt1="rw"
opt2="sync"
opt3="root_squash"
#==================================

# Установим сервер NFS
echo "Установка сервера NFS"
apt install -y nfs-kernel-server

## Создаём и настраиваем каталог для экспорта
mkdir -p "$export_dir"
chown -R nobody:nogroup "$data_dir"
chmod 0777 "$data_dir"

# Прописываем в /etc/exports настройки экспорта
echo "Прописываем в /etc/exports данные экспорта"
echo "$data_dir" "$access_ip"("$opt1","$opt2","$opt3")" >> /etc/exports

# Экспортируем созданный на первом шаге каталог
echo "Экспортируем созданный на первом шаге каталог"
exportfs -r

# Создаем тестовый файл
echo "Создаем тестовый файл"
touch "$export_dir"/test-from-server

# Настройка экспорта завершена
echo "Проверка результатов скрипта"
exportfs -s

# Проверка слушающих портов 2049/udp, 2049/tcp,111/udp, 111/tcp
echo "Проверка слушающих портов 2049/udp, 2049/tcp,111/udp, 111/tcp"
ss -4lnptu | grep -e 2049 -e 111 
echo "Настройка экспорта завершена"
```
### Скрипт установки клиента NFS 
```
#!/bin/bash
# Скрипт выполняет настройку клиента NFS на Ubuntu версии 20 и выше
# ==================================
# Блок переменных - подставить нужные значения
server_ip="192.168.0.14"
data_dir="/srv/share"
mountpoint="/media/share_on_srv06/"
#==================================

# Установим пакет nfs-common
echo "Установка пакета nfs-common"
apt install -y nfs-common

# Монтируем экспортированный каталог
echo "Монтируем экспортированный каталог"
mkdir "$mountpoint"
mount -t nfs "$server_ip:$data_dir $mountpoint"

# Добавляем общий ресурс сервера в /etc/fstab
echo "Добавляем общий ресурс сервера в /etc/fstab"
echo "$server_ip:$data_dir $mountpoint nfs" >> /etc/fstab

# Перечитываем /etc/fstab и рестартуем remote-fs
echo "Перечитываем /etc/fstab и рестартуем remote-fs"
systemctl daemon-reload
systemctl restart remote-fs.target

# Проверяем вывод команды mount
echo "Проверяем вывод команды mount"
mount | grep media

# Проверяем наличие тестового файла
echo "Проверяем наличие тестового файла"
tree "$mountpoint"

# Установка клиента завершена
echo "Установка клиента завершена"
```
## Домашнее задание выполнено




